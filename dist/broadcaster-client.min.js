!function(){function a(a,b){var c=this;b||(b={}),c.mode=f;for(var d in b)c[d]=b[d];if(!a)throw new Error("Missing URL");c.auth||(c.auth={});var e=document.createElement("a");e.href=a,c._secure="https"===e.protocol,c._host=e.host,c._path=e.pathname,c._callbacks={},c._listeners={}}function b(a){this.client=a,this.receive=this.receive.bind(this)}function c(a){this.client=a}function d(a){this[e]=a}var e="__type",f="auto",g="websocket",h="longpoll";a.prototype.connect=function(a){function d(b){return b?a(b):void a()}var e=this,i=e.mode;i===f||i===g?(e._transport=new b(e),e._transport.connect(e.auth,function(a){a&&i===f?(e._transport=new c(e),e._transport.connect(e.auth,d)):d(a)})):i===h?(e._transport=new c(e),e._transport.connect(e.auth,d)):a("Unknown client mode")},a.prototype.url=function(a){var b="ws";return a===h&&(b="http"),this._secure&&(b+="s"),b+"://"+this._host+this._path},a.prototype._call=function(a,b){var c=this,d=a[e]+"_"+a.channel;c._callbacks[d]=b,c._transport.send(a,function(a){a&&b(a)})},a.prototype._receive=function(a){var b=this,c={subscribeError:"subscribe",subscribeOk:"subscribe",unsubscribeError:"unsubscribe",unsubscribeOk:"unsubscribe"};if("message"!==a[e]){var d=c[a[e]]||a[e],f=d+"_"+a.channel;b._callbacks[f]&&b._callbacks[f](null,a)}else{if(!b.onMessage)throw new Error("Missing onMessage handler!");b.onMessage(a.channel,a.body)}},a.prototype.subscribe=function(a,b){var c=new d("subscribe").set("channel",a);this._call(c,function(c,d){if(c)return b(c);if(d.channel!==a)return b(new Error("Channel mismatch"));var f=d[e];"subscribeOk"===f?b():b(new Error("subscribeError"===f?d.reason:"Unexpected "+f))})},a.prototype.unsubscribe=function(a,b){var c=new d("unsubscribe").set("channel",a);this._call(c,function(c,d){if(c)return b(c);if(d.channel!==a)return b(new Error("Channel mismatch"));var f=d[e];"unsubscribeOk"===f?b():b(new Error("unsubscribeError"===f?d.reason:"Unexpected "+f))})},a.prototype.disconnect=function(a){this._transport.disconnect(a)},b.prototype.connect=function(a,b){var c=this,d=new WebSocket(c.client.url(g));d.onmessage=function(a){var f=JSON.parse(a.data);"authFailed"===f[e]?b(new Error(f.reason)):"authOk"===f[e]?(d.onmessage=c.receive,b()):b(new Error("Unexpected message"))},d.onopen=function(){a[e]="auth",c.send(a)},c.conn=d},b.prototype.send=function(a,b){this.conn.send(JSON.stringify(a)),b&&b()},b.prototype.receive=function(a){this.client._receive(JSON.parse(a.data))},b.prototype.disconnect=function(a){this.conn.close(),a()},c.prototype.connect=function(a,b){b()},d.prototype.set=function(a,b){return this[a]=b,this},this.BroadcasterClient=a}();