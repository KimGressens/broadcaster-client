!function(){function a(a,b){var c=this;b||(b={}),c.mode=f;for(var d in b)c[d]=b[d];if(!a)throw new Error("Missing URL");c.auth||(c.auth={}),c.timeout||(c.timeout=3e4);var e=document.createElement("a");e.href=a,c._secure="https"===e.protocol,c._host=e.host,c._path=e.pathname,c._callbacks={},c._listeners={}}function b(a){this.client=a,this.receive=this.receive.bind(this)}function c(a){this.client=a,this.polling=!1,this.pollReq=null,this.pollSeq=0,this.poll=this.poll.bind(this)}function d(a,b){this[e]=a,b&&(this.channel=b)}var e="__type",f="auto",g="websocket",h="longpoll";a.prototype.on=function(a,b){var c=this._listeners;c[a]||(c[a]=[]),c[a].push(b)},a.prototype.off=function(a,b){var c=this._listeners;if(c[a]){b||delete c[a];var d=c[a],e=d.indexOf(b);e>-1&&d.splice(e,1)}},a.prototype._emit=function(a){var b=[].slice.call(arguments,1),c=this._listeners;if(c[a])for(var d=c[a],e=0;e<d.length;e++)d[e].apply(null,b)},a.prototype.connect=function(a){function d(b){return b?a(b):void 0}var i=this;i._callbacks.auth=function(b,c){return b?a(b):void("authError"===c[e]?a(new Error(c.reason)):"authOk"===c[e]?(i._transport.onConnect(c),a()):a(new Error("Unexpected message")))};var j=i.mode;j===f||j===g?(i._transport=new b(i),i._transport.connect(i.auth,function(a){a&&j===f?(i._transport=new c(i),i._transport.connect(i.auth,d)):d(a)})):j===h?(i._transport=new c(i),i._transport.connect(i.auth,d)):a("Unknown client mode")},a.prototype.url=function(a){var b="ws";return a===h&&(b="http"),this._secure&&(b+="s"),b+"://"+this._host+this._path},a.prototype._call=function(a,b){var c=a[e];a.channel&&(c+="_"+a.channel),this._callbacks[c]=b,this._transport.send(a,function(a){a&&b(a)})},a.prototype._receive=function(a){var b=this;if("message"!==a[e]){var c=a[e].replace(/Error$/,"").replace(/Ok$/,"");a.channel&&(c+="_"+a.channel),b._callbacks[c]?(b._callbacks[c](null,a),delete b._callbacks[c]):b._emit("error",a)}else b._emit("message",a.channel,a.body)},a.prototype.subscribe=function(a,b){var c=new d("subscribe",a);this._call(c,function(c,d){if(c)return b(c);if(d.channel!==a)return b(new Error("Channel mismatch"));var f=d[e];"subscribeOk"===f?b():b(new Error("subscribeError"===f?d.reason:"Unexpected "+f))})},a.prototype.unsubscribe=function(a,b){var c=new d("unsubscribe",a);this._call(c,function(c,d){if(c)return b(c);if(d.channel!==a)return b(new Error("Channel mismatch"));var f=d[e];"unsubscribeOk"===f?b():b(new Error("unsubscribeError"===f?d.reason:"Unexpected "+f))})},a.prototype.disconnect=function(a){this._transport.disconnect(a)},b.prototype.connect=function(a,b){var c=this,d=new WebSocket(c.client.url(g));d.onmessage=c.receive,d.onopen=function(){a[e]="auth",c.send(a,b)},d.onerror=function(){b(new Error("Upgrade failed"))},c.conn=d},b.prototype.send=function(a,b){this.conn.send(JSON.stringify(a)),b&&b()},b.prototype.receive=function(a){this.client._receive(JSON.parse(a.data))},b.prototype.onConnect=function(){},b.prototype.disconnect=function(a){this.conn.close(),a()},c.prototype.connect=function(a,b){a[e]="auth",this.send(a,b)},c.prototype.send=function(a,b){var c=this;c.token&&(a.__token=c.token);var d=new XMLHttpRequest;d.open("POST",c.client.url(h),!0),d.setRequestHeader("Content-Type","application/json"),d.addEventListener("load",function(){200===d.status?(c.receive(JSON.parse(d.responseText)),b(null)):b(new Error("Bad response: "+d.status))}),d.addEventListener("error",function(){b(new Error(d.responseText))}),d.send(JSON.stringify(a))},c.prototype.receive=function(a){for(var b=0;b<a.length;b++)this.client._receive(a[b])},c.prototype.onConnect=function(a){this.token=a.__token,this.polling=!0,this.poll()},c.prototype.disconnect=function(a){this.polling=!1,this.pollReq&&this.pollReq.abort(),a()},c.prototype.poll=function(){var a=this,b=new d("poll");b.seq=this.pollSeq.toString(),this.pollReq=a.send(b,function(b){if(b){var c=Math.random()*a.client.timeout/2;setTimeout(a.poll,c)}else a.poll()}),this.pollSeq++},this.BroadcasterClient=a}();